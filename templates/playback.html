<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Memory Playback | Spiral</title>
    <script src="https://cdn.jsdelivr.net/npm/vis-timeline@latest/dist/vis-timeline-graph2d.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vis-timeline@latest/dist/vis-timeline-graph2d.min.css" rel="stylesheet">
    <style>
        #timeline {
            width: 100%;
            height: 400px;
            background: #0f0e15;
            border-radius: 8px;
        }
        .memory-node {
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .cluster {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
        }
        .filters-container {
            margin-bottom: 20px;
        }
        .filter-group {
            margin-bottom: 10px;
        }
        .filter-select {
            width: 150px;
        }
        
        .filters-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 0.9rem;
            color: #e2e8f0;
        }
        .filter-select, #gesture-filter {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #4a5568;
            background: #2d3748;
            color: white;
        }
        #gesture-filter {
            width: 150px;
        }
    </style>
</head>
<body>
    <div class="filters-container">
      <div class="filter-group">
        <label for="toneform-filter">Toneform:</label>
        <select id="toneform-filter" class="filter-select">
          <option value="all">All Toneforms</option>
          {% for toneform in toneforms %}
            <option value="{{ toneform }}">{{ toneform }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label for="days-filter">Time Window:</label>
        <select id="days-filter" class="filter-select">
          <option value="7">Last 7 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="all">All Time</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="gesture-filter">Gesture Strength:</label>
        <input type="range" id="gesture-filter" min="0" max="10" value="3">
        <span id="gesture-value">3+</span>
      </div>
    </div>
    
    <div id="timeline"></div>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const container = document.getElementById('timeline');
            
            try {
                // Load color mappings
                const colorsResponse = await fetch('/reflect/playback/colors');
                const toneformColors = await colorsResponse.json();
                
                // Generate CSS for toneform classes
                const style = document.createElement('style');
                Object.entries(toneformColors).forEach(([tone, color]) => {
                    style.textContent += `.tone-${tone.replace(/\s+/g,'')} { background: ${color}; }\n`;
                });
                document.head.appendChild(style);
                
                const timelineData = JSON.parse('{{ memory_data.timeline_points | tojson | safe }}');
                
                // Add gesture arcs between points
                const itemsData = timelineData.map((point, i) => {
                    const item = {
                        id: point.time,
                        content: `<div class="memory-node tone-${point.tone.replace(/\s+/g,'')}" 
                                  style="width:${point.intensity * 40}px;
                                         height:${point.intensity * 40}px;
                                         box-shadow: 0 0 ${point.intensity * 15}px ${toneformColors[point.tone] || '#888'}"></div>`,
                        start: point.time,
                        title: `${point.tone}: ${point.content}`,
                        className: `intensity-${Math.floor(point.intensity * 10)}`
                    };
                    
                    // Add arc to previous point if same toneform
                    if (i > 0 && timelineData[i-1].tone === point.tone) {
                        const prevTime = new Date(timelineData[i-1].time);
                        const currTime = new Date(point.time);
                        const duration = (currTime - prevTime) / 1000;
                        
                        if (duration < 3600) { // 1 hour max for arcs
                            item.group = point.tone;
                        }
                    }
                    
                    return item;
                });
                
                // Configure timeline with arcs
                new vis.Timeline(
                    container, 
                    new vis.DataSet(itemsData),
                    {
                        showCurrentTime: true,
                        zoomable: true,
                        moveable: true,
                        orientation: 'top',
                        margin: { item: 20 },
                        groupOrder: (a, b) => {
                            // Group by toneform for arcs
                            return a.content.localeCompare(b.content);
                        }
                    }
                );
                
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<p class="text-red-400">Memory playback unavailable</p>';
            }
        });
        
        // Initialize filters from URL params
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('toneform')) {
            document.getElementById('toneform-filter').value = urlParams.get('toneform');
        }
        if (urlParams.has('days')) {
            document.getElementById('days-filter').value = urlParams.get('days');
        }
        if (urlParams.has('gesture_strength')) {
            const strength = urlParams.get('gesture_strength');
            document.getElementById('gesture-filter').value = strength;
            document.getElementById('gesture-value').textContent = strength + '+';
        }

        // Handle filter changes
        document.querySelectorAll('.filter-select, #gesture-filter').forEach(el => {
          el.addEventListener('change', updateTimelineFilters);
        });
        
        // Update gesture strength display
        document.getElementById('gesture-filter').addEventListener('input', function() {
          document.getElementById('gesture-value').textContent = this.value + '+';
        });
        
        // Show loading indicator during filter changes
        function updateTimelineFilters() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '<div class="loading">Filtering memories...</div>';
            
            const toneform = document.getElementById('toneform-filter').value;
            const days = document.getElementById('days-filter').value;
            const gestureStrength = document.getElementById('gesture-filter').value;
            
            window.location.href = `?toneform=${toneform}&days=${days}&gesture_strength=${gestureStrength}`;
        }
    </script>
</body>
</html>
